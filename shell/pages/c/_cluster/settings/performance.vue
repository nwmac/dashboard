<script>
import { Checkbox } from '@components/Form/Checkbox';
import Loading from '@shell/components/Loading';
import AsyncButton from '@shell/components/AsyncButton';
import { Banner } from '@components/Banner';
import { LabeledInput } from '@components/Form/LabeledInput';
import { MANAGEMENT } from '@shell/config/types';
import { SETTING } from '@shell/config/settings';
import { _EDIT, _VIEW } from '@shell/config/query-params';

const DEFAULT_PERF_SETTING = {
  incrementalLoading: {
    enabled:   false,
    threshold: 2500,
  }
};

export default {
  layout: 'authenticated',

  components: {
    Checkbox,
    Loading,
    AsyncButton,
    Banner,
    LabeledInput,
  },

  async fetch() {
    try {
      this.uiPerfSetting = await this.$store.dispatch('management/find', { type: MANAGEMENT.SETTING, id: SETTING.UI_PERFORNMANCE });
    } catch (e) {
      this.uiPerfSetting = await this.$store.dispatch('management/create', { type: MANAGEMENT.SETTING }, { root: true });

      // Setting does not exist - create a new one
      this.uiPerfSetting.value = JSON.parse(JSON.stringify(DEFAULT_PERF_SETTING));
      this.uiPerfSetting.metadata = { name: SETTING.UI_PERFORNMANCE };
    }

    const sValue = this.uiPerfSetting?.value || JSON.stringify(DEFAULT_PERF_SETTING);

    this.value = JSON.parse(sValue);
  },

  data() {
    return {
      uiPerfSetting: DEFAULT_PERF_SETTING,
      bannerVal:     {},
      value:         {},
      errors:        [],
    };
  },

  computed: {
    mode() {
      const schema = this.$store.getters[`management/schemaFor`](MANAGEMENT.SETTING);

      return schema?.resourceMethods?.includes('PUT') ? _EDIT : _VIEW;
    },
  },

  watch: {
    uiBannerSetting(neu) {
      if (neu?.value && neu.value !== '') {
        try {
          const parsedBanner = JSON.parse(neu.value);

          this.bannerVal = this.checkOrUpdateLegacyUIBannerSetting(parsedBanner);
        } catch {}
      }
    }
  },

  methods: {
    async save(btnCB) {
      this.uiPerfSetting.value = JSON.stringify(this.value);

      this.errors = [];

      try {
        await Promise.all([
          this.uiPerfSetting.save()
        ]);
        btnCB(true);
      } catch (err) {
        this.errors.push(err);
        btnCB(false);
      }
    },
  }
};
</script>

<template>
  <Loading v-if="$fetchState.pending" />
  <div v-else>
    <h1 class="mb-20">
      {{ t('performance.label') }}
    </h1>
    <div>
      <label class="text-label">
        {{ t(`performance.description`, {}, true) }}
      </label>

      <Banner color="error" label-key="performance.banner" />

      <!-- Incremental Loading -->
      <div class="ui-perf-setting">
        <h2>{{ t('performance.incrementalLoad.label') }}</h2>
        <p>{{ t('performance.incrementalLoad.description') }}</p>
        <Checkbox v-model="value.incrementalLoading.enabled" label="Enable incremental loading" :primary="true" />
        <div class="ml-20">
          <p :class="{ 'text-muted': !value.incrementalLoading.enabled }">
            {{ t('performance.incrementalLoad.setting') }}
          </p>
          <LabeledInput v-model="value.incrementalLoading.threshold" label="Resource Threshold" :disabled="!value.incrementalLoading.enabled" class="input" />
        </div>
      </div>
    </div>
    <template v-for="err in errors">
      <Banner :key="err" color="error" :label="err" />
    </template>
    <div v-if="mode === 'edit'">
      <AsyncButton class="pull-right mt-20" mode="apply" @click="save" />
    </div>
  </div>
</template>

<style scoped lang='scss'>
.overlay {
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0;
  left: 0;
  background-color: var(--overlay-bg);
  z-index: 1;
}
  .ui-perf-setting {
    P {
      line-height: 1.25;
      margin-bottom: 10px;
    }
  }

  .input {
    max-width: 25%;

  }

</style>
